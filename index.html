<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新春大發寶可夢版 - PennyABC</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&family=Yuji+Boku&family=Yuji+Mai&display=swap"
        rel="stylesheet">

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050101;
            font-family: "Noto Serif TC", "KaiTi", serif;
            user-select: none;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            display: block;
            cursor: none;
        }

        #font-loader {
            font-family: "Yuji Boku";
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        #vfx-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 25;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 30px;
            box-sizing: border-box;
            z-index: 5;
        }

        .header {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 15;
            pointer-events: none;
        }

        @keyframes imgBreathe {

            0%,
            100% {
                transform: scale(1);
                filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.5)) saturate(1.5);
            }

            50% {
                transform: scale(1.2);
                filter: drop-shadow(0 15px 25px rgba(255, 215, 0, 0.6)) saturate(1.5);
            }

            /* 放大並增加金色光暈 */
        }

        /* 定義呼吸動畫：縮放 + 陰影光暈變化 */
        @keyframes cardBreathe {

            0%,
            100% {
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 0 50px rgba(0, 0, 0, 0.8);
            }

            50% {
                transform: translate(-50%, -50%) scale(1.025);
                /* 輕微放大 */
                box-shadow: 0 0 40px rgba(255, 215, 0, 0.9), 0 0 80px rgba(255, 200, 0, 0.4);
                /* 光暈變強 */
            }
        }

        @keyframes shineLoop {
            0% {
                background-position: 0% 50%;
            }

            100% {
                background-position: 200% 50%;
            }
        }

        .title-container {
            display: inline-block;
            position: relative;
            padding: 20px;
        }

        h1 {
            margin: 0;
            font-family: "Yuji Boku", serif;
            font-size: 5rem;
            font-weight: 400;
            letter-spacing: 15px;
            line-height: 1;
            background: linear-gradient(120deg, #8a6e2f 0%, #d4af37 25%, #fceeb5 45%, #ffca28 50%, #fceeb5 55%, #d4af37 75%, #8a6e2f 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            -webkit-text-stroke: 1px #3e2723;
            paint-order: stroke fill;
            animation: shineLoop 6s linear infinite;
            filter: drop-shadow(0 2px 0px #5c4305) drop-shadow(0 5px 10px rgba(0, 0, 0, 0.8));
        }

        @keyframes sparkleFade {
            0% {
                opacity: 0;
                transform: scale(0) rotate(0deg);
            }

            50% {
                opacity: var(--max-opacity);
                transform: scale(1) rotate(180deg);
            }

            100% {
                opacity: 0;
                transform: scale(0) rotate(360deg);
            }
        }

        .sparkle {
            position: absolute;
            background: radial-gradient(circle, #fff8e1 10%, transparent 70%);
            mix-blend-mode: screen;
            pointer-events: none;
            width: var(--size);
            height: var(--size);
            top: var(--top);
            left: var(--left);
            --max-opacity: 1;
            animation: sparkleFade var(--duration) ease-in-out infinite;
            animation-delay: var(--delay);
        }

        .sparkle::before,
        .sparkle::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            background: #ffe082;
            border-radius: 50%;
            box-shadow: 0 0 5px #ffca28;
        }

        .sparkle::before {
            width: 100%;
            height: 10%;
            transform: translate(-50%, -50%);
        }

        .sparkle::after {
            width: 10%;
            height: 100%;
            transform: translate(-50%, -50%);
        }

        #game-status {
            text-align: center;
            margin-top: 10px;
            transition: all 1.5s ease-out;
            opacity: 1;
            line-height: 1.4;
            position: absolute;
            width: 100%;
            top: 200px;
            pointer-events: none;
        }

        .status-line-1 {
            font-family: "Yuji Boku", serif;
            display: block;
            background: linear-gradient(180deg, #fff8e1 0%, #ffd700 40%, #ff8f00 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            filter: drop-shadow(0 2px 0px #8b0000) drop-shadow(0 0 10px rgba(255, 0, 0, 0.5));
            font-size: 3rem;
            letter-spacing: 5px;
        }

        .text-scatter {
            opacity: 0 !important;
            transform: scale(3.0);
            /* 單純放大 3 倍 */
        }

        .score-board {
            position: absolute;
            top: 30px;
            right: 40px;
            background: linear-gradient(180deg, #500000 0%, #2a0000 100%);
            border: 3px solid #b8860b;
            border-radius: 8px;
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.9), 0 0 0 2px #5c4305, 0 15px 40px rgba(0, 0, 0, 0.8);
            padding: 15px 30px;
            text-align: center;
            min-width: 160px;
            z-index: 20;
            overflow: visible;
            transform-style: preserve-3d;
            transition: transform 0.1s;
        }

        .score-board.pop {
            transform: scale(1.2);
        }

        .score-board::before {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            right: 4px;
            bottom: 4px;
            border: 1px solid rgba(255, 215, 0, 0.2);
            pointer-events: none;
        }

        .score-label {
            font-size: 1.4rem;
            color: #ffcc00;
            font-family: "Yuji Boku", serif;
            letter-spacing: 2px;
            margin-bottom: 0px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            position: relative;
            z-index: 10;
        }

        .score-value {
            font-family: "Yuji Mai", serif;
            font-size: 4rem;
            font-weight: 700;
            background: linear-gradient(180deg, #fff 20%, #ffd700 50%, #ffaa00 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            filter: drop-shadow(0 4px 2px rgba(0, 0, 0, 0.9));
            position: relative;
            z-index: 10;
            line-height: 1;
        }

        .ui-loot {
            position: absolute;
            width: 50px;
            height: 50px;
            pointer-events: none;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            left: 50%;
            top: 50%;
            margin-left: -25px;
            margin-top: -25px;
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
        }

        .ui-coin {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%23ffd700' stroke='%23b8860b' stroke-width='4'/%3E%3Crect x='34' y='34' width='32' height='32' fill='%23500000' stroke='%23b8860b' stroke-width='2'/%3E%3C/svg%3E");
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.5));
        }

        .ui-ingot {
            width: 60px;
            height: 40px;
            margin-left: -30px;
            margin-top: -20px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 60'%3E%3Cpath d='M10,20 Q50,60 90,20 L80,10 Q50,40 20,10 Z' fill='%23ffd700' stroke='%23b8860b' stroke-width='2'/%3E%3Cellipse cx='50' cy='15' rx='35' ry='10' fill='%23ffecb3' stroke='%23b8860b' stroke-width='2'/%3E%3C/svg%3E");
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.5));
        }

        .controls-container {
            position: absolute;
            top: 30px;
            left: 30px;
            display: flex;
            gap: 15px;
            z-index: 100;
            pointer-events: auto;
        }

        .icon-btn {
            background: rgba(20, 20, 20, 0.7);
            border: 1px solid #666;
            color: #ccc;
            width: 45px;
            height: 45px;
            border-radius: 8px;
            cursor: pointer;
            pointer-events: auto;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            font-family: "Yuji Mai", serif;
        }

        .icon-btn:hover {
            border-color: #ffd700;
            color: #ffd700;
            background: rgba(40, 40, 40, 0.9);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        .icon-btn.muted {
            color: #555;
            border-color: #333;
            text-decoration: line-through;
        }

        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            z-index: 10;
            transition: opacity 0.5s;
            cursor: default;
        }

        @keyframes metalShine {
            0% {
                left: -100%;
                opacity: 0;
            }

            40% {
                left: 200%;
                opacity: 0.8;
            }

            100% {
                left: 200%;
                opacity: 0;
            }
        }

        button.start-btn {
            background-color: #8b0000;
            background-image: linear-gradient(180deg, #d32f2f 0%, #800000 100%);
            border: none;
            box-shadow: 0 0 0 2px #5a0000, 0 0 0 5px #b8860b, 0 0 0 7px #ffd700, 0 10px 20px rgba(0, 0, 0, 0.6), 0 0 40px rgba(255, 50, 0, 0.4);
            border-radius: 60px;
            color: #fff;
            font-size: 2.8rem;
            padding: 20px 80px;
            font-family: "Yuji Boku", serif;
            letter-spacing: 5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            cursor: pointer;
            pointer-events: auto;
            transition: transform 0.1s;
            position: relative;
            overflow: hidden;
            font-weight: normal;
        }

        button.start-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 60%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.2), rgba(255, 255, 255, 0.8), rgba(255, 215, 0, 0.2), transparent);
            transform: skewX(-25deg);
            mix-blend-mode: overlay;
            animation: metalShine 4s infinite;
        }

        button.start-btn:hover {
            transform: scale(1.02);
            filter: brightness(1.1);
            box-shadow: 0 0 0 2px #5a0000, 0 0 0 5px #d4af37, 0 0 0 7px #ffeb3b, 0 15px 30px rgba(0, 0, 0, 0.7), 0 0 60px rgba(255, 100, 0, 0.6);
        }

        button.start-btn:active {
            transform: scale(0.98) translateY(2px);
        }

        #fa-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 20;
        }

        .final-fa {
            position: absolute;
            top: 38%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: "Yuji Boku", serif;
            font-size: 25rem;
            font-weight: 400;
            line-height: 1;
            color: transparent;
            background: linear-gradient(135deg, #bf953f 0%, #fcf6ba 25%, #b38728 50%, #fbf5b7 75%, #aa771c 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            background-clip: text;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8)) drop-shadow(0 0 30px rgba(255, 69, 0, 0.6)) drop-shadow(4px 4px 0px #5c3a00);
            display: none;
            z-index: 30;
            pointer-events: none;
            animation: megaFaReveal 1.2s cubic-bezier(0.19, 1, 0.22, 1) forwards, faShine 3s linear infinite, faBreathe 4s ease-in-out infinite 1.2s;
        }

        .final-fa.show {
            display: block;
        }

        #restart-btn {
            position: absolute;
            bottom: 10%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            pointer-events: auto;
            display: none;
            opacity: 0;
            transition: opacity 0.5s;
            cursor: pointer;
        }

        .show-restart {
            opacity: 1 !important;
            display: block !important;
        }

        @keyframes megaFaReveal {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(-1080deg);
                opacity: 0;
                filter: blur(50px);
            }

            60% {
                transform: translate(-50%, -50%) scale(1.2) rotate(10deg);
                opacity: 1;
                filter: blur(0px);
            }

            80% {
                transform: translate(-50%, -50%) scale(0.9) rotate(-5deg);
            }

            100% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
            }
        }

        @keyframes faShine {
            0% {
                background-position: 0% 50%;
            }

            100% {
                background-position: 200% 50%;
            }
        }

        @keyframes faBreathe {

            0%,
            100% {
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                transform: translate(-50%, -50%) scale(1.05);
                filter: drop-shadow(0 0 40px rgba(255, 215, 0, 0.8));
            }
        }

        #loading {
            display: none !important;
        }

        /* --- Pokemon Card Styles (原 Fortune Paper Styles) --- */
        #fortune-paper {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-65%, -65%) scale(0);
            width: 300px;
            height: 300px;
            /* 卡片背景：深色半透明質感 */
            background: linear-gradient(135deg, #c9c9ea 0%, #ebebeb 100%);
            border: 4px solid #ffd700;
            /* 金框 */
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 0 50px rgba(0, 0, 0, 0.8);
            padding: 30px;
            z-index: 40;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            color: #fff;
            opacity: 0;
            pointer-events: none;
            overflow: hidden;
        }

        /* 進場動畫 */
        @keyframes cardShow {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(-10deg);
                opacity: 0;
            }

            70% {
                transform: translate(-50%, -50%) scale(1.1) rotate(2deg);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        #fortune-paper.show {
            pointer-events: auto;
            animation: cardShow 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        /* 角色名稱 (中文) */
        .poke-name-cn {
            font-family: "Noto Serif TC", "Yuji Boku", serif;
            font-size: 2.5rem;
            font-weight: 900;
            color: #eed700;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 1.0);
            margin-top: 10px;
        }

        /* 角色圖片容器 */
        .poke-img-container {
            flex-grow: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
        }

        /* 角色圖片 */
        .poke-img {
            max-width: 100%;
            max-height: 500px;
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.5)) saturate(2.0);
            transition: transform 0.3s;
        }

        .poke-img:hover {
            transform: scale(1.5);
        }

        /* 角色名稱 (英文) */
        .poke-name-en {
            font-family: sans-serif;
            font-size: 1.2rem;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        #fortune-paper.show {
            pointer-events: auto;
            /* 先執行進場 (cardShow)，0.6秒後無縫接軌呼吸 (cardBreathe) */
            animation:
                cardShow 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards,
                cardBreathe 3s ease-in-out infinite 0.6s;
        }
    </style>
    <script
        type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js","three/addons/":"https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/","cannon-es":"https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js"}}</script>
</head>

<body>
    <div id="font-loader">發</div>
    <div id="canvas-container"></div><canvas id="vfx-canvas"></canvas>
    <div class="controls-container"><button id="fullscreen-btn" class="icon-btn"
            onclick="toggleFullscreen()">⛶</button><button id="mute-btn" class="icon-btn"
            onclick="toggleMute()">♫</button></div>
    <div id="ui-layer">
        <div class="header">
            <div class="title-container">
                <h1>新春大發</h1>
                <div class="sparkle" style="--size:40px;--top:10%;--left:10%;--duration:3s;--delay:0s"></div>
                <div class="sparkle" style="--size:25px;--top:70%;--left:85%;--duration:4s;--delay:1.5s"></div>
                <div class="sparkle" style="--size:35px;--top:80%;--left:20%;--duration:5s;--delay:2.5s"></div>
                <div class="sparkle" style="--size:30px;--top:15%;--left:75%;--duration:3.5s;--delay:0.5s"></div>
            </div>
        </div>
        <div id="game-status"></div>
        <div class="score-board" id="score-box">
            <div class="score-label">發財指數</div>
            <div class="score-value" id="score">0</div>
        </div>
    </div>

    <!-- Fortune Paper UI -->
    <div id="fortune-paper">
        <div class="fortune-title">籤詩</div>
        <div id="fortune-banner" class="fortune-banner"></div>
        <div id="fortune-content" class="fortune-content"></div>
    </div>

    <div id="fa-overlay">
        <div id="final-fa" class="final-fa">發</div><button id="restart-btn" class="start-btn"
            onclick="window.resetGame()">再玩一次！</button>
    </div>
    <div id="start-screen"><button class="start-btn" id="init-btn">開始遊戲</button>
        <div id="loading"></div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import * as CANNON from 'cannon-es';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        const CONFIG = { firecrackerCount: 120, blastRadius: 4.0, igniteRadius: 3.5, blastForce: 30, fuseTimeMin: 0.3, fuseTimeMax: 1.2, colors: { red: 0xe60000, gold: 0xffcc00, bg: 0x050101 } };
        let scene, camera, renderer, composer, world, controls, clock, deltaTime;
        let firecrackers = [], particles = [], bgDroppers = [];
        let raycaster, mouse, incenseStick, incenseTipLight, isGameActive = false, canIgnite = false;
        let score = 0, explodedCount = 0, visualScore = 0, interactionPlane, lastExplosionTime = 0, gameEnded = false;
        let hangingDecors, groundMesh, groundBody, floorDropping = false, textTimer = null, lastCoinSpawnTime = 0;
        let vfxSystem, audioManager, ambientLight, orangeLight, redLight, warmLight, explosionLight;
        let cameraShake = { x: 0, y: 0, intensity: 0 };
        let lastCharName = null;

        const scoreEl = document.getElementById('score'), scoreBox = document.getElementById('score-box');
        const startScreen = document.getElementById('start-screen'), restartBtn = document.getElementById('restart-btn'), initBtn = document.getElementById('init-btn');
        const statusEl = document.getElementById('game-status'), faOverlay = document.getElementById('fa-overlay'), finalFa = document.getElementById('final-fa');
        const fortunePaper = document.getElementById('fortune-paper'), fortuneBanner = document.getElementById('fortune-banner'), fortuneContent = document.getElementById('fortune-content');

        // Fortune Data
        // Pokemon Data
        const pokemonData = [
            {
                min: 90, tier: "傳說級", chars: [
                    { zh: "皮卡丘", en: "Pikachu", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/025.png" },
                    { zh: "伊布", en: "Eevee", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/133.png" },
                    { zh: "噴火龍", en: "Charizard", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/006.png" }
                ]
            },
            {
                min: 80, tier: "神話級", chars: [
                    { zh: "夢幻", en: "Mew", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/151.png" },
                    { zh: "超夢", en: "Mewtwo", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/150.png" },
                    { zh: "阿爾宙斯", en: "Arceus", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/493.png" },
                    { zh: "烈空坐", en: "Rayquaza", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/384.png" }
                ]
            },
            {
                min: 70, tier: "幻之寶可夢", chars: [
                    { zh: "桃歹郎", en: "Pecharunt", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/1025.png" },
                    { zh: "薩戮德", en: "Zarude", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/893.png" },
                    { zh: "捷拉奧拉", en: "Zeraora", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/807.png" },
                    { zh: "瑪夏多", en: "Marshadow", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/802.png" },
                    { zh: "美錄坦", en: "Meltan", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/808.png" },
                    { zh: "美錄梅塔", en: "Melmetal", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/809.png" },
                    { zh: "蒂安希", en: "Diancie", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/719.png" },
                    { zh: "胡帕", en: "Hoopa", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/720.png" },
                    { zh: "波爾凱尼恩", en: "Volcanion", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/721.png" },
                    { zh: "瑪機雅娜", en: "Magearna", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/801.png" },
                    { zh: "維克蒂尼", en: "Victini", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/494.png" },
                    { zh: "蓋諾賽克特", en: "Genesect", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/649.png" },
                    { zh: "美洛耶塔", en: "Meloetta", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/648.png" },
                    { zh: "凱路迪歐", en: "Keldeo", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/647.png" },
                    { zh: "謝米", en: "Shaymin", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/492.png" },
                    { zh: "達克萊伊", en: "Darkrai", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/491.png" },
                    { zh: "瑪納霏", en: "Manaphy", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/490.png" },
                    { zh: "基拉祈", en: "Jirachi", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/385.png" },
                    { zh: "代歐奇希斯", en: "Deoxys", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/386.png" },
                    { zh: "雪拉比", en: "Celebi", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/251.png" }
                ]
            },
            {
                min: 60, tier: "傳說寶可夢", chars: [
                    { zh: "太樂巴戈斯", en: "Terapagos", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/1024.png" },
                    { zh: "故勒頓", en: "Koraidon", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/1007.png" },
                    { zh: "密勒頓", en: "Miraidon", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/1008.png" },
                    { zh: "蒼響", en: "Zacian", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/888.png" },
                    { zh: "藏瑪然特", en: "Zamazenta", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/889.png" },
                    { zh: "無極汰那", en: "Eternatus", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/890.png" },
                    { zh: "奈克洛茲瑪", en: "Necrozma", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/800.png" },
                    { zh: "索爾迦雷歐", en: "Solgaleo", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/791.png" },
                    { zh: "露奈雅拉", en: "Lunala", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/792.png" },
                    { zh: "哲爾尼亞斯", en: "Xerneas", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/716.png" },
                    { zh: "伊裴爾塔爾", en: "Yveltal", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/717.png" },
                    { zh: "基格爾德", en: "Zygarde", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/718.png" },
                    { zh: "萊希拉姆", en: "Reshiram", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/643.png" },
                    { zh: "捷克羅姆", en: "Zekrom", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/644.png" },
                    { zh: "酋雷姆", en: "Kyurem", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/646.png" },
                    { zh: "帝牙盧卡", en: "Dialga", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/483.png" },
                    { zh: "帕路奇亞", en: "Palkia", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/484.png" },
                    { zh: "騎拉帝納", en: "Giratina", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/487.png" },
                    { zh: "固拉多", en: "Groudon", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/383.png" },
                    { zh: "蓋歐卡", en: "Kyogre", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/382.png" },
                    { zh: "鳳王", en: "Ho-Oh", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/250.png" },
                    { zh: "洛奇亞", en: "Lugia", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/249.png" }
                ]
            },
            {
                min: 50, tier: "災厄與傳說", chars: [
                    { zh: "厄鬼椪", en: "Ogerpon", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/1017.png" },
                    { zh: "古劍豹", en: "Chien-Pao", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/1002.png" },
                    { zh: "古鼎鹿", en: "Ting-Lu", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/1003.png" },
                    { zh: "古玉魚", en: "Chi-Yu", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/1004.png" },
                    { zh: "古簡蝸", en: "Wo-Chien", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/1001.png" },
                    { zh: "夠讚狗", en: "Okidogi", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/1014.png" },
                    { zh: "願增猿", en: "Munkidori", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/1015.png" },
                    { zh: "吉雉雞", en: "Fezandipiti", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/1016.png" },
                    { zh: "蕾冠王", en: "Calyrex", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/898.png" },
                    { zh: "雪暴馬", en: "Glastrier", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/896.png" },
                    { zh: "靈幽馬", en: "Spectrier", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/897.png" },
                    { zh: "眷戀雲", en: "Enamorus", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/905.png" },
                    { zh: "武道熊師", en: "Urshifu", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/892.png" },
                    { zh: "銀伴戰獸", en: "Silvally", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/773.png" }
                ]
            },
            {
                min: 40, tier: "悖謬寶可夢 (究極異獸)", chars: [
                    { zh: "轟鳴月", en: "Roaring Moon", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/1005.png" },
                    { zh: "鐵武者", en: "Iron Valiant", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/1006.png" },
                    { zh: "波蕩水", en: "Walking Wake", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/1009.png" },
                    { zh: "鐵斑葉", en: "Iron Leaves", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/1010.png" },
                    { zh: "破空焰", en: "Gouging Fire", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/1020.png" },
                    { zh: "猛雷鼓", en: "Raging Bolt", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/1021.png" },
                    { zh: "鐵磐岩", en: "Iron Boulder", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/1022.png" },
                    { zh: "鐵頭殼", en: "Iron Crown", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/1023.png" },
                    { zh: "虛吾伊德", en: "Nihilego", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/793.png" },
                    { zh: "費洛美螳螂", en: "Pheromosa", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/795.png" },
                    { zh: "爆肌蚊", en: "Buzzwole", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/794.png" },
                    { zh: "鐵火輝夜", en: "Celesteela", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/797.png" },
                    { zh: "紙御劍", en: "Kartana", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/798.png" },
                    { zh: "惡食大王", en: "Guzzlord", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/799.png" },
                    { zh: "四顎針龍", en: "Naganadel", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/804.png" }
                ]
            },
            {
                min: 30, tier: "準神級", chars: [
                    { zh: "戟脊龍", en: "Baxcalibur", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/998.png" },
                    { zh: "多龍巴魯托", en: "Dragapult", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/887.png" },
                    { zh: "杖尾鱗甲龍", en: "Kommo-o", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/784.png" },
                    { zh: "黏美龍", en: "Goodra", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/706.png" },
                    { zh: "三首惡龍", en: "Hydreigon", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/635.png" },
                    { zh: "烈咬陸鯊", en: "Garchomp", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/445.png" },
                    { zh: "巨金怪", en: "Metagross", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/376.png" },
                    { zh: "暴飛龍", en: "Salamence", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/373.png" },
                    { zh: "班基拉斯", en: "Tyranitar", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/248.png" },
                    { zh: "快龍", en: "Dragonite", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/149.png" }
                ]
            },
            {
                min: 20, tier: "人氣寶可夢", chars: [
                    { zh: "索財靈", en: "Gimmighoul", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/999.png" },
                    { zh: "賽富豪", en: "Gholdengo", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/1000.png" },
                    { zh: "仙子伊布", en: "Sylveon", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/700.png" },
                    { zh: "謎擬Q", en: "Mimikyu", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/778.png" },
                    { zh: "路卡利歐", en: "Lucario", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/448.png" },
                    { zh: "甲賀忍蛙", en: "Greninja", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/658.png" },
                    { zh: "耿鬼", en: "Gengar", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/094.png" },
                    { zh: "沙奈朵", en: "Gardevoir", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/282.png" },
                    { zh: "索羅亞克", en: "Zoroark", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/571.png" }
                ]
            },
            {
                min: 0, tier: "潛力寶可夢", chars: [
                    { zh: "古空棘魚", en: "Relicanth", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/369.png" },
                    { zh: "象徵鳥", en: "Sigilyph", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/561.png" },
                    { zh: "帕奇利茲", en: "Pachirisu", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/417.png" },
                    { zh: "聒噪鳥", en: "Chatot", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/441.png" },
                    { zh: "尖牙籠", en: "Carnivine", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/455.png" },
                    { zh: "摔角鷹人", en: "Hawlucha", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/701.png" },
                    { zh: "鑰圈兒", en: "Klefki", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/707.png" },
                    { zh: "花療環環", en: "Comfey", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/764.png" },
                    { zh: "花舞鳥", en: "Oricorio", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/741.png" },
                    { zh: "燃燒蟲", en: "Larvesta", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/636.png" },
                    { zh: "火神蛾", en: "Volcarona", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/637.png" },
                    { zh: "夜盜火蜥", en: "Salandit", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/757.png" },
                    { zh: "焰后蜥", en: "Salazzle", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/758.png" },
                    { zh: "涼脊龍", en: "Frigibax", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/996.png" },
                    { zh: "炭小侍", en: "Charcadet", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/935.png" },
                    { zh: "蒼炎刃鬼", en: "Ceruledge", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/937.png" },
                    { zh: "紅蓮鎧騎", en: "Armarouge", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/936.png" },
                    { zh: "海地鼠", en: "Wiglett", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/960.png" },
                    { zh: "噗隆隆", en: "Varoom", img: "https://assets.pokemon.com/assets/cms2/img/pokedex/detail/965.png" }
                ]
            }
        ];

        function createFaTexture() {
            const canvas = document.createElement('canvas'); canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d'); ctx.font = 'bold 100px "Yuji Boku", serif';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillStyle = '#ffffdd'; ctx.fillText('發', 64, 64);
            return new THREE.CanvasTexture(canvas);
        }

        // Global functions defined first
        function spawnGoldExplosionParticles(pos) {
            for (let i = 0; i < 15; i++) {
                const p = new Particle(pos, 0xffd700, 0.08, 10, 0.5, 'spark'); p.vel.y += 5; particles.push(p);
            }
            particles.push(new Particle(pos, 0xffffee, 8.0, 0, 0.1, 'flash'));
        }

        function spawnExplosion(pos) {
            const p = new THREE.Vector3(pos.x, pos.y, pos.z);
            particles.push(new Particle(p, 0xffaa33, 7.0, 0, 0.12, 'flash'));
            for (let i = 0; i < 10; i++) particles.push(new Particle(p, 0xffcc00, 0.15, 15, 0.6 + Math.random() * 0.4, 'spark'));
            for (let i = 0; i < 5; i++) particles.push(new Particle(p, 0xe60000, 0.1, 8, 1.0 + Math.random(), 'debris'));
            for (let i = 0; i < Math.floor(Math.random() * 3) + 2; i++) particles.push(new Particle(p, Math.random() > 0.5 ? 0xffd700 : 0xd90d24, 0.2, 10, 1.5, Math.random() > 0.5 ? 'coin' : 'envelope'));
            if (explosionLight) { explosionLight.position.copy(p); explosionLight.intensity = 500; }
            cameraShake.intensity = 0.5;
        }

        function spawnSpark(pos, count, color, type = 'spark') {
            for (let i = 0; i < count; i++) particles.push(new Particle(pos, color, 0.05, 3, 0.3 + Math.random() * 0.2, type));
        }

        function spawnUICoins() {
            for (let i = 0; i < 3; i++) {
                const e = document.createElement('div'); e.className = Math.random() > 0.6 ? 'ui-loot ui-ingot' : 'ui-loot ui-coin';
                scoreBox.appendChild(e); e.style.left = '50%'; e.style.top = '50%';
                let vx = Math.cos(Math.random() * 6) * 150, vy = -300 - Math.random() * 150, x = 0, y = 0, l = 1;
                const f = (t) => { if (!e.lt) e.lt = t; const dt = Math.min((t - e.lt) / 1000, 0.05); e.lt = t; l -= 0.5 * dt; if (l <= 0) { e.remove(); return; } vy += 800 * dt; x += vx * dt; y += vy * dt; e.style.transform = `translate(${x}px,${y}px) scale(${l})`; requestAnimationFrame(f); };
                requestAnimationFrame(f);
            }
            scoreBox.classList.add('pop'); setTimeout(() => scoreBox.classList.remove('pop'), 100);
        }

        function spawnBackgroundFirecracker() { bgDroppers.push(new FallingProp()); }

        function triggerEndGame() {
            gameEnded = true; statusEl.innerText = ""; canIgnite = false; incenseStick.visible = false; floorDropping = true; world.removeBody(groundBody);
            firecrackers.forEach(fc => { fc.body.wakeUp(); fc.body.velocity.y -= 2; });
            faOverlay.style.pointerEvents = 'auto'; faOverlay.style.opacity = 1; finalFa.classList.add('show');
            if (vfxSystem) vfxSystem.explode(window.innerWidth / 2, window.innerHeight / 2);
            setTimeout(() => audioManager.playFinalExplosion(), 100);

            // Fortune/Pokemon Card Logic
            setTimeout(() => {
                const finalScore = visualScore;
                let data = pokemonData[pokemonData.length - 1]; // Default low tier
                // Find correct tier
                for (let i = 0; i < pokemonData.length; i++) {
                    if (finalScore >= pokemonData[i].min) {
                        data = pokemonData[i];
                        break;
                    }
                }

                // Pick random character
                // 1. 先排除上一局的角色 (如果有的話)
                let availableChars = data.chars.filter(c => c.zh !== lastCharName);

                // 2. 如果該等級只有一隻角色(被過濾光了)，就只好重置為全部
                if (availableChars.length === 0) availableChars = data.chars;

                // 3. 從過濾後的清單中隨機抽取
                const char = availableChars[Math.floor(Math.random() * availableChars.length)];

                // 4. 更新記錄，供下一局使用
                lastCharName = char.zh;

                // Clear and Populate HTML
                fortunePaper.innerHTML = '';

                // 1. Chinese Name
                const cnName = document.createElement('div');
                cnName.className = 'poke-name-cn';
                cnName.textContent = char.zh;
                fortunePaper.appendChild(cnName);

                // 2. Image
                const imgContainer = document.createElement('div');
                imgContainer.className = 'poke-img-container';
                const img = document.createElement('img');
                img.className = 'poke-img';
                img.src = char.img;
                img.alt = char.zh;
                imgContainer.appendChild(img);
                fortunePaper.appendChild(imgContainer);

                // 3. English Name
                const enName = document.createElement('div');
                enName.className = 'poke-name-en';
                enName.textContent = char.en;
                fortunePaper.appendChild(enName);

                // Show Card
                fortunePaper.classList.add('show');
            }, 2200);

            setTimeout(() => { restartBtn.style.display = 'block'; setTimeout(() => restartBtn.classList.add('show-restart'), 10); }, 3500);
        }

        function checkEndGame() { if (!gameEnded && explodedCount > 0 && (clock.getElapsedTime() - lastExplosionTime > 1.5)) triggerEndGame(); }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
            if (vfxSystem) vfxSystem.resize();
        }

        function onMouseMove(e) {
            if (!canIgnite) return; mouse.x = (e.clientX / window.innerWidth) * 2 - 1; mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera); const h = raycaster.intersectObject(interactionPlane);
            if (h.length > 0) {
                incenseStick.position.set(h[0].point.x, 0.5, h[0].point.z);
                if (Math.random() > 0.7 && incenseTipLight) {
                    const p = new THREE.Vector3();
                    incenseTipLight.getWorldPosition(p);
                    p.x += (Math.random() - 0.5) * 0.05;
                    p.z += (Math.random() - 0.5) * 0.05;
                    particles.push(new Particle(p, 0xdddddd, 0.1, 1, 2.0, 'smoke'));
                }
            }
        }

        function onMouseDown(e) {
            if (!canIgnite || e.button !== 0 || gameEnded) return;
            const tip = new THREE.Vector3(); incenseTipLight.getWorldPosition(tip);
            let t = null, d = 2.5;
            firecrackers.forEach(fc => {
                if (fc.state === 'idle') {
                    let p = new THREE.Vector3(); if (fc.fuseTip) { p.set(0, 1.25, 0); p.applyMatrix4(fc.mesh.matrixWorld); } else { p.copy(fc.mesh.position); }
                    const dist = p.distanceTo(tip); if (dist < d) { d = dist; t = fc; }
                }
            });
            if (t && t.type !== 'goldbar') { t.ignite(); audioManager.playFuse(); lastExplosionTime = clock.getElapsedTime(); canIgnite = false; incenseStick.visible = false; }
        }

        // --- CLASSES ---
        class Shockwave {
            constructor(x, y, z) {
                this.life = 0; this.maxLife = 30;
                this.ring = new THREE.Mesh(new THREE.RingGeometry(0.5, 1.5, 32), new THREE.MeshBasicMaterial({ color: 0xffffaa, transparent: true, opacity: 0.8, side: THREE.DoubleSide, depthWrite: false, blending: THREE.AdditiveBlending }));
                this.ring.position.set(x, y + 0.1, z); this.ring.rotation.x = -Math.PI / 2; scene.add(this.ring);
                this.sphere = new THREE.Mesh(new THREE.SphereGeometry(1, 16, 16), new THREE.MeshBasicMaterial({ color: 0xffdd44, transparent: true, opacity: 0.15, blending: THREE.AdditiveBlending, depthWrite: false }));
                this.sphere.position.set(x, y, z); scene.add(this.sphere);
            }
            update() {
                this.life++; const progress = this.life / this.maxLife; const scale = 1 + progress * 10.0;
                this.ring.scale.set(scale, scale, 1); this.ring.material.opacity = 0.8 * (1 - progress);
                this.sphere.scale.setScalar(scale * 0.8); this.sphere.material.opacity = 0.15 * (1 - progress);
                if (this.life >= this.maxLife) { this.dispose(); return false; }
                return true;
            }
            dispose() { scene.remove(this.ring); scene.remove(this.sphere); this.ring.geometry.dispose(); this.ring.material.dispose(); this.sphere.geometry.dispose(); this.sphere.material.dispose(); }
        }

        class Particle {
            constructor(pos, color, size, speed, life, type = 'debris') {
                this.type = type; this.pos = pos.clone(); this.life = life; this.maxLife = life; this.color = new THREE.Color(color);
                const theta = 2 * Math.PI * Math.random(), phi = Math.acos(2 * Math.random() - 1);
                this.vel = new THREE.Vector3(Math.sin(phi) * Math.cos(theta), Math.sin(phi) * Math.sin(theta), Math.cos(phi)).multiplyScalar(speed * Math.random());
                let material;
                if (type === 'flash') {
                    this.vel.set(0, 0, 0);
                    const cvs = document.createElement('canvas'); cvs.width = 64; cvs.height = 64; const ctx = cvs.getContext('2d');
                    const g = ctx.createRadialGradient(32, 32, 0, 32, 32, 32); g.addColorStop(0, 'rgba(255,255,220,1)'); g.addColorStop(0.4, 'rgba(255,200,50,0.8)'); g.addColorStop(1, 'rgba(255,100,0,0)');
                    ctx.fillStyle = g; ctx.fillRect(0, 0, 64, 64);
                    material = new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(cvs), transparent: true, blending: THREE.AdditiveBlending, depthWrite: false });
                    this.mesh = new THREE.Sprite(material); this.mesh.scale.set(size, size, 1);
                } else if (type === 'smoke') {
                    this.vel.set((Math.random() - 0.5) * 0.5, 1.5 + Math.random(), (Math.random() - 0.5) * 0.5);
                    this.mesh = new THREE.Mesh(new THREE.PlaneGeometry(size, size), new THREE.MeshBasicMaterial({ color: color, side: THREE.DoubleSide, transparent: true, depthWrite: false, opacity: 0.4 }));
                } else if (type === 'coin') {
                    this.mesh = new THREE.Mesh(new THREE.CylinderGeometry(0.12, 0.12, 0.02, 16), new THREE.MeshStandardMaterial({ color: 0xffd700, roughness: 0.2, metalness: 1.0 }));
                    this.mesh.rotation.x = Math.random() * Math.PI;
                } else if (type === 'envelope') {
                    this.mesh = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.3, 0.01), new THREE.MeshBasicMaterial({ color: 0xd90d24, side: THREE.DoubleSide }));
                    this.mesh.rotation.set(Math.random(), Math.random(), Math.random());
                } else {
                    this.mesh = new THREE.Mesh(new THREE.BoxGeometry(size, size, size), new THREE.MeshBasicMaterial({ color: color, transparent: true, blending: THREE.AdditiveBlending }));
                }
                this.mesh.position.copy(this.pos);
                if (type !== 'flash' && type !== 'coin' && type !== 'envelope') this.mesh.lookAt(camera.position);
                scene.add(this.mesh);
            }
            update(dt) {
                this.life -= dt; const lr = this.life / this.maxLife;
                if (this.type === 'flash') { this.mesh.material.opacity = lr; const s = this.mesh.scale.x + dt * 5; this.mesh.scale.set(s, s, 1); }
                else if (this.type === 'smoke') { this.vel.x += (Math.random() - 0.5) * 0.1; this.vel.z += (Math.random() - 0.5) * 0.1; this.pos.add(this.vel.clone().multiplyScalar(dt)); this.mesh.material.opacity = lr * 0.3; const s = 1 + (1 - lr) * 2; this.mesh.scale.set(s, s, 1); this.mesh.lookAt(camera.position); }
                else if (this.type === 'spark') { this.vel.y -= 9.8 * dt; this.vel.multiplyScalar(0.9); this.pos.add(this.vel.clone().multiplyScalar(dt)); if (lr < 0.7) this.mesh.material.color.setHex(0xff6600); if (lr < 0.3) this.mesh.material.color.setHex(0x330000); this.mesh.scale.setScalar(lr); }
                else { this.vel.y -= 8 * dt; if (!floorDropping && this.pos.y < 0) { this.pos.y = 0; this.vel.y *= -0.5; this.vel.x *= 0.9; this.vel.z *= 0.9; } this.pos.add(this.vel.clone().multiplyScalar(dt)); this.mesh.rotation.x += dt * 5; this.mesh.rotation.y += dt * 3; }
                this.mesh.position.copy(this.pos);
                return this.life > 0;
            }
            dispose() { scene.remove(this.mesh); this.mesh.geometry.dispose(); this.mesh.material.dispose(); }
        }

        class VFXSystem {
            constructor() {
                this.canvas = document.getElementById('vfx-canvas'); this.ctx = this.canvas.getContext('2d');
                this.particles = []; this.shockwaves = []; this.resize(); window.addEventListener('resize', () => this.resize()); this.loop();
            }
            resize() { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; }
            createShockwave(x, y, z) { this.shockwaves.push(new Shockwave(x, y, z)); }
            explodeGold(x, y) {
                // No 2D particles for gold now, using 3D
            }
            explode(x, y) {
                // 2D Explosion
                for (let i = 0; i < 200; i++) {
                    const angle = Math.random() * Math.PI * 2, speed = Math.random() * 15 + 5;
                    this.particles.push({ x, y, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, alpha: 1, size: Math.random() * 4 + 2, friction: 0.95, gravity: 0.1, hue: Math.random() > 0.5 ? 45 : 10, decay: Math.random() * 0.01 + 0.005 });
                }
            }
            loop() {
                for (let i = this.shockwaves.length - 1; i >= 0; i--) { if (!this.shockwaves[i].update()) { this.shockwaves[i].dispose(); this.shockwaves.splice(i, 1); } }
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height); this.ctx.globalCompositeOperation = 'lighter';
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const p = this.particles[i]; p.x += p.vx; p.y += p.vy; p.vx *= p.friction; p.vy *= p.friction; p.vy += p.gravity; p.alpha -= p.decay;
                    if (p.alpha <= 0) { this.particles.splice(i, 1); continue; }
                    this.ctx.fillStyle = p.hue === 0 ? `rgba(255,255,255,${p.alpha})` : `hsla(${p.hue},100%,60%,${p.alpha})`;
                    this.ctx.beginPath(); this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); this.ctx.fill();
                }
                requestAnimationFrame(() => this.loop());
            }
        }

        class AudioManager {
            constructor() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.masterGain = this.ctx.createGain(); this.masterGain.gain.value = 0.5; this.masterGain.connect(this.ctx.destination);
                this.isPlayingBGM = false; this.bgmOscs = []; this.nextNoteTime = 0; this.noteIndex = 0; this.isMuted = false; this.bgmVolume = 0.03;
            }
            resume() { if (this.ctx.state === 'suspended') this.ctx.resume(); }
            toggleMute() { this.isMuted = !this.isMuted; if (this.isMuted) muteBtn.classList.add('muted'); else muteBtn.classList.remove('muted'); return this.isMuted; }
            playStartSound() {
                const t = this.ctx.currentTime, osc = this.ctx.createOscillator(), g = this.ctx.createGain();
                osc.frequency.setValueAtTime(80, t); osc.frequency.exponentialRampToValueAtTime(30, t + 0.3);
                g.gain.setValueAtTime(0.8, t); g.gain.exponentialRampToValueAtTime(0.01, t + 0.3);
                osc.connect(g); g.connect(this.masterGain); osc.start(t); osc.stop(t + 0.3);
            }
            startBGM() { if (this.isPlayingBGM) return; this.isPlayingBGM = true; this.nextNoteTime = this.ctx.currentTime + 0.1; this.scheduleNote(); }
            stopBGM() { this.isPlayingBGM = false; this.bgmOscs.forEach(o => { try { o.stop(); } catch (e) { } }); this.bgmOscs = []; if (this.timerID) clearTimeout(this.timerID); }
            scheduleNote() {
                if (!this.isPlayingBGM) return;
                const N = { G3: 196, A3: 220, B3: 246, C4: 261, D4: 293, E4: 329, F4: 349, G4: 392, A4: 440, B4: 493 };
                const melody = [{ f: N.A3, d: 1 }, { f: N.B3, d: 1 }, { f: N.C4, d: 1 }, { f: N.D4, d: 1 }, { f: N.F4, d: 1 }, { f: N.E4, d: 1 }, { f: N.E4, d: 2 }, { f: N.E4, d: 1 }, { f: N.A4, d: 1 }, { f: N.A4, d: 1 }, { f: N.E4, d: 1 }, { f: N.E4, d: 1 }, { f: N.D4, d: 1 }, { f: N.D4, d: 2 }, { f: N.E4, d: 1 }, { f: N.F4, d: 1 }, { f: N.E4, d: 1 }, { f: N.D4, d: 1 }, { f: N.D4, d: 1 }, { f: N.C4, d: 1 }, { f: N.C4, d: 2 }, { f: N.C4, d: 1 }, { f: N.B3, d: 1 }, { f: N.A3, d: 1 }, { f: N.G3, d: 1 }, { f: N.A3, d: 2 }, { f: N.A3, d: 2 }, { f: N.D4, d: 1.5 }, { f: N.E4, d: 0.5 }, { f: N.C4, d: 1.5 }, { f: N.E4, d: 0.5 }, { f: N.B3, d: 1.5 }, { f: N.E4, d: 0.5 }, { f: N.A3, d: 1.5 }, { f: N.E4, d: 0.5 }, { f: N.D4, d: 1.5 }, { f: N.E4, d: 0.5 }, { f: N.C4, d: 1.5 }, { f: N.E4, d: 0.5 }, { f: N.B3, d: 1.5 }, { f: N.E4, d: 0.5 }, { f: N.A3, d: 2 }, { f: 0, d: 4 }];
                const note = melody[this.noteIndex % melody.length];
                if (note.f > 0 && !this.isMuted) {
                    const osc = this.ctx.createOscillator(); osc.type = 'square'; osc.frequency.value = note.f;
                    const g = this.ctx.createGain(); g.gain.setValueAtTime(this.bgmVolume, this.nextNoteTime); g.gain.exponentialRampToValueAtTime(0.01, this.nextNoteTime + note.d * 0.25 - 0.05);
                    osc.connect(g); g.connect(this.masterGain); osc.start(this.nextNoteTime); osc.stop(this.nextNoteTime + note.d * 0.25);
                }
                this.nextNoteTime += note.d * 0.25; this.noteIndex++;
                this.timerID = setTimeout(() => this.scheduleNote(), Math.max(0, (this.nextNoteTime - this.ctx.currentTime - 0.05) * 1000));
            }
            playImpact(v) { if (v < 1) return; const t = this.ctx.currentTime, o = this.ctx.createOscillator(), g = this.ctx.createGain(); o.type = 'triangle'; o.frequency.setValueAtTime(80, t); o.frequency.exponentialRampToValueAtTime(10, t + 0.1); g.gain.setValueAtTime(Math.min(1, v / 20) * 0.3, t); g.gain.exponentialRampToValueAtTime(0.01, t + 0.1); o.connect(g); g.connect(this.masterGain); o.start(t); o.stop(t + 0.1); }
            playExplosion(pos) { this._playBoom(pos, 80, 1); }
            playGoldExplosion(pos) { this._playBoom(pos, 40, 1.5, true); }
            playFinalExplosion() {
                const t = this.ctx.currentTime;
                // Kick
                const oscKick = this.ctx.createOscillator(); oscKick.type = 'sine';
                oscKick.frequency.setValueAtTime(40, t); oscKick.frequency.exponentialRampToValueAtTime(20, t + 0.5);
                const gainKick = this.ctx.createGain(); gainKick.gain.setValueAtTime(0, t);
                gainKick.gain.linearRampToValueAtTime(2.5, t + 0.05); gainKick.gain.exponentialRampToValueAtTime(0.01, t + 1.0);
                oscKick.connect(gainKick); gainKick.connect(this.masterGain); oscKick.start(t); oscKick.stop(t + 1.0);

                // Noise
                const b = this.ctx.createBuffer(1, this.ctx.sampleRate * 2.0, this.ctx.sampleRate);
                const d = b.getChannelData(0); for (let i = 0; i < d.length; i++) d[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / d.length, 4);
                const n = this.ctx.createBufferSource(); n.buffer = b;
                const f = this.ctx.createBiquadFilter(); f.type = 'lowpass'; f.frequency.setValueAtTime(800, t); f.frequency.linearRampToValueAtTime(100, t + 1.5);
                const gn = this.ctx.createGain(); gn.gain.setValueAtTime(1.5, t); gn.gain.exponentialRampToValueAtTime(0.01, t + 1.5);
                n.connect(f); f.connect(gn); gn.connect(this.masterGain); n.start(t);

                // Chime
                const oscC = this.ctx.createOscillator(); oscC.type = 'sine'; oscC.frequency.setValueAtTime(523.25, t);
                const gc = this.ctx.createGain(); gc.gain.setValueAtTime(0, t); gc.gain.linearRampToValueAtTime(0.3, t + 0.1); gc.gain.exponentialRampToValueAtTime(0.01, t + 4.0);
                oscC.connect(gc); gc.connect(this.masterGain); oscC.start(t); oscC.stop(t + 4.0);
            }
            _playBoom(pos, freq, vol, gold = false) {
                const t = this.ctx.currentTime, p = this.ctx.createStereoPanner(), g = this.ctx.createGain();
                if (camera) { const v = pos.clone().project(camera); p.pan.value = Math.max(-1, Math.min(1, v.x)); }
                p.connect(this.masterGain); g.connect(p);
                const o = this.ctx.createOscillator(); o.type = 'sine'; o.frequency.setValueAtTime(freq, t); o.frequency.exponentialRampToValueAtTime(10, t + (gold ? 0.8 : 0.4));
                const og = this.ctx.createGain(); og.gain.setValueAtTime(vol, t); og.gain.exponentialRampToValueAtTime(0.01, t + (gold ? 0.8 : 0.4)); o.connect(og); og.connect(g); o.start(t); o.stop(t + (gold ? 0.8 : 0.4));
                const b = this.ctx.createBuffer(1, this.ctx.sampleRate * (gold ? 0.5 : 0.25), this.ctx.sampleRate), d = b.getChannelData(0);
                for (let i = 0; i < d.length; i++)d[i] = Math.random() * 2 - 1;
                const n = this.ctx.createBufferSource(); n.buffer = b; const ng = this.ctx.createGain(); ng.gain.setValueAtTime(vol * (gold ? 0.8 : 1.8), t); ng.gain.exponentialRampToValueAtTime(0.01, t + (gold ? 0.4 : 0.25));
                const f = this.ctx.createBiquadFilter(); f.type = gold ? 'lowpass' : 'highpass'; f.frequency.value = gold ? 200 : 600;
                n.connect(f); f.connect(ng); ng.connect(g); n.start(t);
            }
            playFuse() {
                const t = this.ctx.currentTime, b = this.ctx.createBuffer(1, this.ctx.sampleRate * 0.15, this.ctx.sampleRate), d = b.getChannelData(0);
                for (let i = 0; i < d.length; i++)d[i] = Math.random() * 2 - 1;
                const n = this.ctx.createBufferSource(); n.buffer = b; const f = this.ctx.createBiquadFilter(); f.type = 'bandpass'; f.frequency.value = 3000;
                const g = this.ctx.createGain(); g.gain.setValueAtTime(0.3, t); g.gain.linearRampToValueAtTime(0, t + 0.15);
                n.connect(f); f.connect(g); g.connect(this.masterGain); n.start(t);
            }
        }

        class FallingProp {
            constructor() {
                this.mesh = new THREE.Group();
                const r = Math.random();
                let subType = 'firecracker';
                if (r < 0.33) subType = 'coin'; else if (r < 0.66) subType = 'envelope';

                if (subType === 'coin') {
                    const m = new THREE.MeshPhysicalMaterial({
                        color: 0xffd700, metalness: 0.6, roughness: 0.3, emissive: 0x554400, emissiveIntensity: 0.6, clearcoat: 1.0
                    });
                    const body = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.6, 0.08, 32), m);
                    body.rotation.x = Math.PI / 2;
                    const holeMat = new THREE.MeshBasicMaterial({ color: 0x000000 });
                    const hole = new THREE.Mesh(new THREE.BoxGeometry(0.35, 0.35, 0.1), holeMat);
                    this.mesh.add(body); this.mesh.add(hole);
                } else if (subType === 'envelope') {
                    // Red Envelope Shape
                    const mat = new THREE.MeshBasicMaterial({ color: 0xd90d24, side: THREE.DoubleSide });
                    const body = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.2, 0.05), mat);
                    const goldMat = new THREE.MeshBasicMaterial({ color: 0xffd700 });
                    const stripe = new THREE.Mesh(new THREE.BoxGeometry(0.82, 0.3, 0.06), goldMat);
                    stripe.position.y = 0.2;
                    // Add a small gold square in middle
                    const center = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.2, 0.07), goldMat);
                    center.position.y = 0.2;

                    this.mesh.add(body);
                    this.mesh.add(stripe);
                    this.mesh.add(center);
                } else {
                    const b = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.3, 1.5, 8), new THREE.MeshBasicMaterial({ color: 0xe60000 }));
                    const c = new THREE.Mesh(new THREE.CylinderGeometry(0.31, 0.31, 0.2, 8), new THREE.MeshBasicMaterial({ color: 0xffd700 })); c.position.y = 0.6;
                    this.mesh.add(b, c);
                }
                this.mesh.position.set((Math.random() - 0.5) * 30, 25, (Math.random() - 0.5) * 20);
                this.mesh.rotation.set(Math.random() * 6, Math.random() * 6, Math.random() * 6);
                this.speed = 5 + Math.random() * 5; this.rot = { x: (Math.random() - 0.5) * 3, y: (Math.random() - 0.5) * 3, z: (Math.random() - 0.5) * 3 };
                scene.add(this.mesh);
            }
            update(dt) {
                this.mesh.position.y -= this.speed * dt;
                this.mesh.rotation.x += this.rot.x * dt; this.mesh.rotation.y += this.rot.y * dt; this.mesh.rotation.z += this.rot.z * dt;
                // Add wind
                const windIntensity = 3;
                this.mesh.position.x += (Math.random() - 0.5) * windIntensity * dt;
                return this.mesh.position.y > -20;
            }
            dispose() { scene.remove(this.mesh); }
        }

        class Firecracker {
            constructor(x, y, z) {
                this.state = 'idle'; this.type = 'firecracker'; this.fuseTimer = 0; this.mesh = new THREE.Group();
                const bm = new THREE.MeshStandardMaterial({ color: 0xe60000, roughness: 0.4 });
                const cm = new THREE.MeshStandardMaterial({ color: 0xffd700, roughness: 0.2, metalness: 0.9 });
                this.mesh.add(new THREE.Mesh(new THREE.CylinderGeometry(0.35, 0.35, 1.6, 12), bm));
                const t = new THREE.Mesh(new THREE.CylinderGeometry(0.36, 0.36, 0.2, 12), cm); t.position.y = 0.7; this.mesh.add(t);
                const b = new THREE.Mesh(new THREE.CylinderGeometry(0.36, 0.36, 0.2, 12), cm); b.position.y = -0.7; this.mesh.add(b);
                const f = new THREE.Mesh(new THREE.CylinderGeometry(0.04, 0.04, 0.5, 6), new THREE.MeshStandardMaterial({ color: 0xaaaaaa })); f.position.y = 1.0; this.mesh.add(f);
                this.fuseTip = new THREE.Vector3(0, 1.25, 0); this.mesh.children.forEach(c => { c.castShadow = true; c.receiveShadow = true });
                this.body = new CANNON.Body({ mass: 0.8, material: new CANNON.Material({ friction: 0.4, restitution: 0.2 }) });
                this.body.addShape(new CANNON.Box(new CANNON.Vec3(0.3, 0.8, 0.3)));
                this.body.position.set(x, y, z); this.body.quaternion.setFromEuler(Math.random() * 6, Math.random() * 6, Math.random() * 6);
                this.body.linearDamping = 0.3; this.body.angularDamping = 0.3; this.body.userData = { parent: this };
                this.body.addEventListener('collide', e => { if (Math.abs(e.contact.getImpactVelocityAlongNormal()) > 3) audioManager.playImpact(Math.abs(e.contact.getImpactVelocityAlongNormal())) });
                scene.add(this.mesh); world.addBody(this.body);
            }
            update(dt) {
                this.mesh.position.copy(this.body.position); this.mesh.quaternion.copy(this.body.quaternion);
                if (this.state === 'lit') {
                    this.fuseTimer -= dt; const p = this.fuseTip.clone().applyMatrix4(this.mesh.matrixWorld);
                    spawnSpark(p, 2, 0xffffdd, 'fuse');
                    if (this.fuseTimer <= 0) this.explode();
                }
            }
            ignite(delay = 0) { if (this.state !== 'idle') return; this.state = 'lit'; this.body.wakeUp(); this.fuseTimer = CONFIG.fuseTimeMin + Math.random() * 0.9 + delay; if (Math.random() > 0.6) audioManager.playFuse(); }
            explode() {
                if (this.state === 'exploded') return; this.state = 'exploded'; explodedCount++; visualScore++; scoreEl.innerText = visualScore;
                if (clock.getElapsedTime() - lastCoinSpawnTime > 0.1) { spawnUICoins(); lastCoinSpawnTime = clock.getElapsedTime(); }
                lastExplosionTime = clock.getElapsedTime();
                const p = new THREE.Vector3(this.body.position.x, this.body.position.y, this.body.position.z);
                spawnExplosion(p);
                this.mesh.visible = false; audioManager.playExplosion(p);
                const bp = new CANNON.Vec3(p.x, p.y, p.z);
                firecrackers.forEach(fc => {
                    if (fc === this) return; const d = fc.body.position.distanceTo(bp);
                    if (d < CONFIG.blastRadius) {
                        const dir = fc.body.position.vsub(bp); dir.normalize();
                        const imp = dir.scale(CONFIG.blastForce * (1 - d / CONFIG.blastRadius)); imp.y += 0.5;
                        if (fc.type === 'goldbar') imp.scale(0.1, imp);
                        fc.body.applyImpulse(imp, fc.body.position); fc.body.wakeUp();
                        if (fc.state === 'idle' && d < CONFIG.igniteRadius) fc.ignite(d * 0.05 + Math.random() * 0.2);
                    }
                });
                setTimeout(() => world.removeBody(this.body), 50);
            }
            dispose() { }
        }

        class GoldBar {
            constructor(x, y, z) {
                this.type = 'goldbar'; this.state = 'idle'; this.fuseTimer = 0; this.mesh = new THREE.Group();
                // Revert to Trapezoidal Prism (Brick) Shape per request
                // Use cylinder with 4 radial segments
                const topW = 0.8;
                const botW = 1.0;
                const height = 0.6;
                const geo = new THREE.CylinderGeometry(topW, botW, height, 4, 1);
                geo.rotateY(Math.PI / 4);

                this.mat = new THREE.MeshPhysicalMaterial({
                    color: 0xffd700,
                    metalness: 1.3,
                    roughness: 0.5,
                    emissive: 0xaa8800,
                    emissiveIntensity: 0.8,
                    clearcoat: 1.0,
                    clearcoatRoughness: 0.1,
                    envMapIntensity: 2.0,
                    flatShading: true
                });

                const brick = new THREE.Mesh(geo, this.mat);
                // Scale: 1.725, 1.2, 0.92 (V5.0/V6.0 scale)
                brick.scale.set(1.725, 1.2, 0.92);
                brick.castShadow = true;
                brick.receiveShadow = true;
                this.mesh.add(brick);

                const fm = new THREE.SpriteMaterial({ map: createFaTexture(), transparent: true, opacity: 0 });
                this.fa = new THREE.Sprite(fm); this.fa.scale.set(1.5, 1.5, 1); scene.add(this.fa);

                this.body = new CANNON.Body({ mass: 50, material: new CANNON.Material({ friction: 0.8, restitution: 0.05 }), linearDamping: 0.1, angularDamping: 0.1 });
                this.body.addShape(new CANNON.Box(new CANNON.Vec3(0.6, 0.45, 0.35)));
                this.body.position.set(x, y, z); this.body.quaternion.setFromEuler(Math.random() * 6, Math.random() * 6, Math.random() * 6);
                this.body.userData = { parent: this };
                this.body.addEventListener('collide', e => { if (Math.abs(e.contact.getImpactVelocityAlongNormal()) > 2) audioManager.playImpact(Math.abs(e.contact.getImpactVelocityAlongNormal())) });
                scene.add(this.mesh); world.addBody(this.body);
            }
            update(dt) {
                this.mesh.position.copy(this.body.position); this.mesh.quaternion.copy(this.body.quaternion);
                if (this.fa) { this.fa.position.copy(this.body.position); this.fa.position.y += 3; }
                this.mat.emissiveIntensity = 0.6 + Math.sin(clock.getElapsedTime() * 5) * 0.2;
                if (this.state === 'lit') {
                    this.fuseTimer -= dt;
                    this.mesh.position.addScalar((Math.random() - 0.5) * 0.08); // Jitter
                    let s = 1.0; if (this.fuseTimer < 0.5) s = 1.0 + (1.0 - this.fuseTimer / 0.5) * 1.5;
                    this.mesh.scale.setScalar(s);
                    if (this.fa) {
                        this.fa.material.opacity = Math.min(0.85, (1.0 - this.fuseTimer) * 3);
                        const fs = 1.5 * (1.0 + (1.0 - this.fuseTimer) * 3.0); this.fa.scale.set(fs, fs, 1);
                    }
                    spawnSpark(this.mesh.position, 10, 0xffd700, 'spark');
                    if (this.fuseTimer <= 0) this.explode();
                } else if (this.fa) this.fa.material.opacity = 0;
            }
            ignite(delay = 0) {
                if (this.state !== 'idle') return; this.state = 'lit'; this.body.wakeUp();
                firecrackers.forEach(o => { if (o !== this && o.state === 'idle' && o.body.position.distanceTo(this.body.position) < 5.0) o.ignite(Math.random() * 0.1) });
                this.fuseTimer = 0.5 + Math.random() * 0.3 + delay; if (Math.random() > 0.6) audioManager.playFuse();
            }
            explode() {
                if (this.state === 'exploded') return; this.state = 'exploded'; visualScore += 10; scoreEl.innerText = visualScore;
                const p = new THREE.Vector3(this.body.position.x, this.body.position.y, this.body.position.z);
                spawnGoldExplosionParticles(p);
                if (vfxSystem) vfxSystem.createShockwave(p.x, p.y, p.z);
                audioManager.playGoldExplosion(p); this.mesh.visible = false;
                if (this.fa) { scene.remove(this.fa); this.fa = null; }
                const bp = new CANNON.Vec3(p.x, p.y, p.z);
                firecrackers.forEach(fc => {
                    if (fc === this) return; const d = fc.body.position.distanceTo(bp);
                    if (d < CONFIG.blastRadius * 1.5) {
                        const dir = fc.body.position.vsub(bp); dir.normalize();
                        const imp = dir.scale(50.0 * (1 - d / (CONFIG.blastRadius * 1.5))); imp.y += 0.8;
                        if (fc.type === 'goldbar') imp.scale(0.1, imp);
                        fc.body.applyImpulse(imp, fc.body.position); fc.body.wakeUp();
                        if (fc.state === 'idle') fc.ignite(d * 0.01);
                    }
                });
                setTimeout(() => world.removeBody(this.body), 50);
            }
            dispose() { if (this.fa) { scene.remove(this.fa); this.fa = null; } }
        }

        // --- INIT & LOGIC ---
        function createHangingDecor() {
            if (hangingDecors) {
                if (hangingDecors.parent) hangingDecors.parent.remove(hangingDecors);
            }
            hangingDecors = new THREE.Group();
            const addDecor = (xOffset, zRot) => {
                const g = new THREE.Group();
                const b = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.6, 2.5, 16), new THREE.MeshStandardMaterial({ color: 0xe60000 }));
                const t = new THREE.Mesh(new THREE.CylinderGeometry(0.62, 0.62, 0.3, 16), new THREE.MeshStandardMaterial({ color: 0xffd700 })); t.position.y = 1.1;
                const bot = new THREE.Mesh(new THREE.CylinderGeometry(0.62, 0.62, 0.3, 16), new THREE.MeshStandardMaterial({ color: 0xffd700 })); bot.position.y = -1.1;
                const f = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.08, 0.8, 8), new THREE.MeshBasicMaterial({ color: 0x888888 })); f.position.y = 1.4;
                const tip = new THREE.Object3D(); tip.position.set(0, 1.8, 0); tip.name = 'fuseTip';
                g.add(b, t, bot, f, tip); g.position.set(xOffset, 0, 0); g.rotation.z = zRot; hangingDecors.add(g);
            };

            addDecor(-10, 0.1);
            addDecor(10, -0.1);

            // Fixed relative to camera
            hangingDecors.position.set(0, 12, -35);
            hangingDecors.rotation.set(0.4, 0, 0);

            camera.add(hangingDecors);
        }

        function createIncense() {
            const g = new THREE.Group(), c = new THREE.Group();

            // 1. 香的火光 (原本已有設定，保持並確認 renderOrder)
            const tip = new THREE.Mesh(
                new THREE.SphereGeometry(0.08),
                new THREE.MeshBasicMaterial({
                    color: 0xff3300,
                    depthTest: false, // 關鍵：無視深度，永遠顯示
                    depthWrite: false
                })
            );
            tip.position.y = 0.5;
            tip.renderOrder = 9999; // 設為極大值，確保最後繪製
            c.add(tip);

            const l = new THREE.PointLight(0xff3300, 2, 5); l.position.y = 0.5; c.add(l); incenseTipLight = l;

            // 2. 香身 (咖啡色部分) - 加入 depthTest: false
            const bMat = new THREE.MeshStandardMaterial({
                color: 0x5c3a21,
                depthTest: false, // 關鍵：關閉深度測試
                depthWrite: false,
                transparent: true // 建議開啟，配合 renderOrder 運作更好
            });
            const b = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 6), bMat);
            b.position.y = 0.5 - 3;
            b.renderOrder = 9998; // 設為大數值，確保在其他物體之後繪製
            c.add(b);

            // 3. 香腳 (紅色握把部分) - 加入 depthTest: false
            const hMat = new THREE.MeshStandardMaterial({
                color: 0xaa0000,
                depthTest: false, // 關鍵：關閉深度測試
                depthWrite: false,
                transparent: true
            });
            const h = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 1.5), hMat);
            h.position.y = 0.5 - 6 - 0.75;
            h.renderOrder = 9998; // 設為大數值
            c.add(h);

            c.rotation.set(0, -0.35, 1.57); g.add(c); incenseStick = g; incenseStick.visible = false; scene.add(incenseStick);
        }

        function spawnFirecrackers() {
            firecrackers.forEach(fc => { scene.remove(fc.mesh); if (world) world.removeBody(fc.body); if (fc.dispose) fc.dispose(); });
            firecrackers = []; bgDroppers.forEach(d => d.dispose()); bgDroppers = [];
            score = 0; explodedCount = 0; visualScore = 0; scoreEl.innerText = "0"; gameEnded = false; floorDropping = false;
            if (textTimer) clearTimeout(textTimer);
            if (world && groundBody) { world.removeBody(groundBody); world.addBody(groundBody); }
            if (groundMesh) groundMesh.position.y = 0;

            // Reset Camera Position & Target
            camera.position.set(0, 18, 22);
            camera.lookAt(0, 0, 0);
            cameraShake.intensity = 0; // Clear shake
            if (controls) controls.target.set(0, 0, 0);

            faOverlay.style.opacity = 0; faOverlay.style.pointerEvents = 'none'; finalFa.classList.remove('show');
            fortunePaper.classList.remove('show'); // Hide fortune paper
            restartBtn.style.display = 'none'; restartBtn.classList.remove('show-restart');
            if (hangingDecors) hangingDecors.visible = true; canIgnite = false;
            statusEl.innerHTML = '<span class="status-line-1">恭喜發大財</span>';
            statusEl.classList.remove('text-scatter'); textTimer = setTimeout(() => statusEl.classList.add('text-scatter'), 3000);
            incenseStick.visible = false;
            for (let i = 0; i < CONFIG.firecrackerCount; i++) {
                const a = Math.random() * Math.PI * 2, r = Math.sqrt(Math.random()) * 12;
                firecrackers.push(new Firecracker(Math.cos(a) * r, 5 + Math.random() * 10, Math.sin(a) * r));
            }
            for (let i = 0; i < Math.floor(Math.random() * 3) + 1; i++) {
                const a = Math.random() * Math.PI * 2, r = Math.sqrt(Math.random()) * 12;
                firecrackers.push(new GoldBar(Math.cos(a) * r, 5 + Math.random() * 10, Math.sin(a) * r));
            }
            setTimeout(() => { canIgnite = true; incenseStick.visible = true; }, 3500);
        }

        function init() {
            scene = new THREE.Scene(); scene.background = new THREE.Color(CONFIG.colors.bg); scene.fog = new THREE.FogExp2(CONFIG.colors.bg, 0.02);
            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000); camera.position.set(0, 18, 22); camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" });
            renderer.setPixelRatio(1); renderer.setSize(window.innerWidth, window.innerHeight); renderer.shadowMap.enabled = false; renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping; renderer.toneMappingExposure = 1.2;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            /* composer = new EffectComposer(renderer);
            const renderPass = new RenderPass(scene, camera); composer.addPass(renderPass);
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.threshold = 0.5; bloomPass.strength = 0.8; bloomPass.radius = 0.5; composer.addPass(bloomPass); */

            ambientLight = new THREE.AmbientLight(0xffcccc, 0.1); scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xaaccff, 0.3); dirLight.position.set(10, 30, -10); scene.add(dirLight);
            orangeLight = new THREE.PointLight(0xff5500, 150, 100); orangeLight.position.set(-8, 6, -8); scene.add(orangeLight);
            redLight = new THREE.PointLight(0xff0000, 120, 100); redLight.position.set(8, 6, 8); scene.add(redLight);
            warmLight = new THREE.PointLight(0xffaa55, 80, 80); warmLight.position.set(0, 8, 0); scene.add(warmLight);
            explosionLight = new THREE.PointLight(0xffaa33, 0, 50); scene.add(explosionLight);

            world = new CANNON.World(); world.gravity.set(0, -9.82, 0); world.broadphase = new CANNON.NaiveBroadphase(); world.solver.iterations = 20; world.allowSleep = true;
            world.addContactMaterial(new CANNON.ContactMaterial(new CANNON.Material(), new CANNON.Material(), { friction: 0.5, restitution: 0.2 }));

            const cvs = document.createElement('canvas'); cvs.width = 512; cvs.height = 512; const cx = cvs.getContext('2d');
            cx.fillStyle = '#4a0e0e'; cx.fillRect(0, 0, 512, 512); for (let i = 0; i < 50000; i++) { cx.fillStyle = `rgba(255,255,255,${Math.random() * 0.1})`; cx.fillRect(Math.random() * 512, Math.random() * 512, 2, 2); } cx.strokeStyle = '#2a0505'; cx.lineWidth = 4; for (let y = 0; y < 512; y += 64)for (let x = 0; x < 512; x += 64) { if (Math.random() > 0.5) cx.fillRect(x, y, 64, 64); cx.strokeRect(x, y, 64, 64); }
            const tex = new THREE.CanvasTexture(cvs); tex.wrapS = tex.wrapT = THREE.RepeatWrapping; tex.repeat.set(10, 10);
            groundMesh = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshStandardMaterial({ map: tex, color: 0x888888, roughness: 0.8, metalness: 0.2 }));
            groundMesh.rotation.x = -Math.PI / 2; groundMesh.receiveShadow = true; scene.add(groundMesh);
            groundBody = new CANNON.Body({ mass: 0, shape: new CANNON.Plane() }); groundBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0); world.addBody(groundBody);
            interactionPlane = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshBasicMaterial({ visible: false }));
            interactionPlane.rotation.x = -Math.PI / 2; interactionPlane.position.y = 1.0; scene.add(interactionPlane);

            controls = new OrbitControls(camera, renderer.domElement); controls.enableDamping = true; controls.enableRotate = false; controls.enableZoom = false;
            raycaster = new THREE.Raycaster(); mouse = new THREE.Vector2();

            window.addEventListener('resize', onWindowResize); window.addEventListener('mousemove', onMouseMove); window.addEventListener('mousedown', onMouseDown);

            audioManager = new AudioManager(); clock = new THREE.Clock(); vfxSystem = new VFXSystem();
            createIncense(); createHangingDecor(); animate();

            // Add camera to scene for hanging decors
            scene.add(camera);
        }

        function animate() {
            requestAnimationFrame(animate); deltaTime = Math.min(clock.getDelta(), 0.1); const t = clock.getElapsedTime();
            if (isGameActive && incenseStick.visible && !gameEnded && Math.random() > 0.7) {
                if (incenseTipLight) {
                    const p = new THREE.Vector3(); incenseTipLight.getWorldPosition(p);
                    p.x += (Math.random() - 0.5) * 0.05; p.z += (Math.random() - 0.5) * 0.05;
                    particles.push(new Particle(p, 0xdddddd, 0.1, 1, 2.0, 'smoke'));
                }
            }
            if (floorDropping) groundMesh.position.y -= 8 * deltaTime;

            if (cameraShake.intensity > 0) {
                const shake = cameraShake.intensity;
                camera.position.x += (Math.random() - 0.5) * shake;
                camera.position.y += (Math.random() - 0.5) * shake;
                camera.position.z += (Math.random() - 0.5) * shake;
                cameraShake.intensity *= 0.9;
                if (cameraShake.intensity < 0.01) cameraShake.intensity = 0;
            }

            if (orangeLight) { orangeLight.intensity = 150 + Math.sin(t * 8) * 20; redLight.intensity = 120 + Math.sin(t * 6.5) * 20; orangeLight.position.x = -8 + Math.sin(t * 0.8); redLight.position.x = 8 + Math.cos(t * 0.8); }
            if (explosionLight && explosionLight.intensity > 0) { explosionLight.intensity *= 0.8; }
            if (hangingDecors) { hangingDecors.rotation.y = Math.sin(t * 0.3) * 0.05; hangingDecors.children.forEach(c => { c.rotation.y += 0.02; for (let k = 0; k < 5; k++) if (Math.random() > 0.1) { const tip = c.getObjectByName('fuseTip'); if (tip) { const p = new THREE.Vector3(); tip.getWorldPosition(p); const pt = new Particle(p, Math.random() > 0.5 ? 0xffd700 : 0xff4400, 0.2, 4, 0.8, 'spark'); pt.vel.y += 6; pt.vel.x += (Math.random() - 0.5) * 6; pt.vel.z += (Math.random() - 0.5) * 6; particles.push(pt); } } }); }
            if (gameEnded) { if (Math.random() < 0.3) spawnBackgroundFirecracker(); for (let i = bgDroppers.length - 1; i >= 0; i--)if (!bgDroppers[i].update(deltaTime)) { bgDroppers[i].dispose(); bgDroppers.splice(i, 1); } }
            if (isGameActive) { world.step(1 / 60, deltaTime, 3); firecrackers.forEach(fc => fc.update(deltaTime)); for (let i = particles.length - 1; i >= 0; i--)if (!particles[i].update(deltaTime)) { particles[i].dispose(); particles.splice(i, 1); } if (vfxSystem) vfxSystem.loop(); checkEndGame(); }
            if (!isGameActive || gameEnded) for (let i = particles.length - 1; i >= 0; i--)if (!particles[i].update(deltaTime)) { particles[i].dispose(); particles.splice(i, 1); }
            controls.update(); // composer.render(); // 註解掉這行
            renderer.render(scene, camera); // 改用原生的渲染
        }

        window.toggleFullscreen = () => { if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(() => { }); else if (document.exitFullscreen) document.exitFullscreen(); };
        window.toggleMute = () => { audioManager.toggleMute(); };
        window.resetGame = () => { if (audioManager) { audioManager.stopBGM(); audioManager.playStartSound(); audioManager.startBGM(); } spawnFirecrackers(); isGameActive = true; };

        init();
        initBtn.addEventListener('click', () => {
            if (audioManager) audioManager.playStartSound();
            initBtn.style.display = 'none';
            const loading = document.getElementById('loading');
            if (loading) loading.style.display = 'none';
            setTimeout(() => {
                spawnFirecrackers();
                startScreen.style.opacity = 0;
                setTimeout(() => startScreen.style.display = 'none', 500);
                audioManager.resume();
                audioManager.startBGM();
                isGameActive = true;
            }, 200);
        });
    </script>
</body>

</html>